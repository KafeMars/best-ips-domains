name: Update BestProxyIPs

on:
  schedule:
    - cron: '0 * * * *' 
  workflow_dispatch: 

jobs:
  update-ips:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: è·å–å¹¶æ›´æ–° IP åœ°å€
        run: |
          set -e
          curl -s -f --connect-timeout 10 --retry 2 'https://ipdb.api.030101.xyz/?type=bestproxy' | \
          grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | \
          sort -u > temp_ips.txt || {
            echo "é”™è¯¯ï¼šæ— æ³•è·å–æˆ–æå– IP åœ°å€"
            exit 1
          }

          [ -s temp_ips.txt ] || { echo "é”™è¯¯ï¼šIP åˆ—è¡¨ä¸ºç©º"; exit 1; }

          [ -f BestProxyIPs ] && cmp -s temp_ips.txt BestProxyIPs && { echo "IP åœ°å€æ— å˜åŒ–"; rm temp_ips.txt; exit 0; }

          mv temp_ips.txt BestProxyIPs || { echo "é”™è¯¯ï¼šæ— æ³•æ›´æ–° BestProxyIPs æ–‡ä»¶"; exit 1; }
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          git add BestProxyIPs
          git commit -m "ğŸ¤– Update BestProxyIPs $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M')" || true
          git pull --rebase origin main || { echo "é”™è¯¯ï¼šgit pull --rebase å¤±è´¥"; exit 1; }
          git push origin main || { echo "é”™è¯¯ï¼šgit push å¤±è´¥"; exit 1; }
          echo "æˆåŠŸæ›´æ–° BestProxyIPs"
        shell: bash
