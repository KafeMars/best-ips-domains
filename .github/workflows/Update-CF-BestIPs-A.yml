name: Update CF-BestIPs-A
on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update-ips:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²è®°å½•

      - name: èŽ·å–å¹¶æ›´æ–° IP åœ°å€
        run: |
          set -e
          # èŽ·å–ç½‘é¡µå†…å®¹å¹¶æå–æ‰€æœ‰ IPv4 åœ°å€
          # è‹¥éœ€æ›´æ¢é“¾æŽ¥ï¼Œä¿®æ”¹ä»¥ä¸‹ URL å³å¯ï¼Œä¾‹å¦‚ï¼š'https://new.example.com/ip-list'
          curl -s -f --connect-timeout 10 --retry 2 'https://www.wetest.vip/api/cf2dns/get_cloudflare_ip?key=o1zrmHAF&type=v4' | \
          grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | \
          sort -u > temp_ips.txt || {
            echo "é”™è¯¯ï¼šæ— æ³•èŽ·å–æˆ–æå– IP åœ°å€"
            exit 1
          }

          # æ£€æŸ¥ temp_ips.txt æ˜¯å¦ä¸ºç©º
          [ -s temp_ips.txt ] || { echo "é”™è¯¯ï¼šIP åˆ—è¡¨ä¸ºç©º"; exit 1; }

          # å¤„ç†æ¯ä¸ª IPï¼šæ·»åŠ ç«¯å£
          > CF-BestIPs-A  # æ¸…ç©º CF-BestIPs-A æ–‡ä»¶
          while IFS= read -r ip; do
            # æ·»åŠ ç«¯å£
            echo "${ip}:8443" >> CF-BestIPs-A
          done < temp_ips.txt

          # ç§»é™¤ä¸´æ—¶æ–‡ä»¶
          rm temp_ips.txt

          # æ£€æŸ¥ CF-BestIPs-A æ˜¯å¦ä¸ºç©º
          [ -s CF-BestIPs-A ] || { echo "é”™è¯¯ï¼šIP åˆ—è¡¨ä¸ºç©º"; exit 1; }

          # æäº¤æ›´æ–°
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          git add CF-BestIPs-A
          git commit -m "ðŸ¤– Update CF-BestIPs-A $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M')" || true
          git pull --rebase origin main || { echo "é”™è¯¯ï¼šgit pull --rebase å¤±è´¥"; exit 1; }
          git push origin main || { echo "é”™è¯¯ï¼šgit push å¤±è´¥"; exit 1; }
          echo "æˆåŠŸæ›´æ–° CF-BestIPs-A"
        shell: /usr/bin/bash -e {0}
