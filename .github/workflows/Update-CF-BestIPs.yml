name: Update CF-BestIPs

on:
  schedule:
    - cron: '*/15 * * * *'  # 每15分钟运行一次
  workflow_dispatch: # 支持手动触发

jobs:
  update-ips:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录

      - name: 获取并更新 IP 地址
        run: |
          set -e
          
          # 使用 wget 下载网页内容并进行重试
          wget --quiet --waitretry=10 --retry-connrefused --timeout=30 --tries=10 -O temp_page.html 'https://api.uouin.com/cloudflare.html' || {
            echo "错误：无法获取页面"
            exit 1
          }

          # 使用一个较长时间的检查机制，确保 IP 列表更新
          last_content=""
          for i in {1..10}; do
            current_content=$(cat temp_page.html)
            if [[ "$current_content" != "$last_content" ]]; then
              echo "页面内容已更新"
              break
            fi
            echo "等待页面更新..."
            sleep 10
            last_content="$current_content"
          done

          # 提取 IP 地址
          grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' temp_page.html | \
          awk '!seen[$0]++' > temp_ips.txt || {
            echo "错误：无法提取 IP 地址"
            exit 1
          }

          # 检查 temp_ips.txt 是否为空
          [ -s temp_ips.txt ] || { echo "错误：IP 列表为空"; exit 1; }

          # 处理每个 IP 地址，添加端口
          > CF-BestIPs  # 清空 CF-BestIPs 文件
          while IFS= read -r ip; do
            ip_port="${ip}:8443"
            echo "${ip_port}" >> CF-BestIPs
          done < temp_ips.txt

          # 移除临时文件
          rm temp_ips.txt

          # 检查 CF-BestIPs 是否为空
          [ -s CF-BestIPs ] || { echo "错误：IP 列表为空"; exit 1; }

          # 提交更新
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          git add CF-BestIPs
          git commit -m "自动更新 CF-BestIPs $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M')" || true
          git pull --rebase origin main || { echo "错误：git pull --rebase 失败"; exit 1; }
          git push origin main || { echo "错误：git push 失败"; exit 1; }
          echo "成功更新 CF-BestIPs"
        shell: /usr/bin/bash -e {0}
