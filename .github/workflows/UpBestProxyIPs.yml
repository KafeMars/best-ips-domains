name: Update BestProxyIPs

on:
  workflow_dispatch:

jobs:
  update-ips:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ä¿ç•™å®Œæ•´ Git å†å²ä»¥ä¾¿ rebase

      - name: è·å–å¹¶æ›´æ–° IP åœ°å€
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ”„ è·å–æœ€æ–°ä»£ç† IP..."
          if ! curl -s -f --connect-timeout 10 --retry 3 'https://ipdb.api.030101.xyz/?type=bestproxy' \
            | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' \
            | sort -u > temp_ips.txt; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•è·å–æˆ–æå– IP åœ°å€"
            exit 1
          fi

          if [ ! -s temp_ips.txt ]; then
            echo "âŒ é”™è¯¯ï¼šIP åˆ—è¡¨ä¸ºç©º"
            exit 1
          fi

          if [ -f BestProxyIPs ] && cmp -s temp_ips.txt BestProxyIPs; then
            echo "â„¹ï¸ IP åœ°å€æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°ã€‚"
            rm temp_ips.txt
            exit 0
          fi

          mv temp_ips.txt BestProxyIPs
          echo "âœ… IP æ–‡ä»¶å·²æ›´æ–°ï¼Œå‡†å¤‡æäº¤ã€‚"

          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          git add BestProxyIPs
          git commit -m "ğŸ¤– Update BestProxyIPs $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M')" || true

          echo "ğŸ” åŒæ­¥è¿œç¨‹åˆ†æ”¯..."
          for i in {1..3}; do
            if git pull --rebase origin main; then
              break
            else
              echo "âš ï¸ ç¬¬ $i æ¬¡ pull å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
              sleep 5
            fi
          done

          echo "ğŸš€ æ¨é€æ›´æ–°åˆ°è¿œç¨‹..."
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… æˆåŠŸæ›´æ–° BestProxyIPs"
              exit 0
            else
              echo "âš ï¸ ç¬¬ $i æ¬¡ push å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
              git fetch origin main
              sleep 5
            fi
          done

          echo "âŒ é”™è¯¯ï¼šå¤šæ¬¡æ¨é€å¤±è´¥"
          exit 1
