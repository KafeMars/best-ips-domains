name: Update CF-BestIPs

on:
  schedule:
    - cron: '*/15 * * * *'  # 每15分钟运行一次
  workflow_dispatch: # 支持手动触发

jobs:
  update_best_ips:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Fetch CF-BestIPs from GitHub
        run: |
          curl -o CF-BestIPs https://raw.githubusercontent.com/kafemars/best-ips-domains/main/CF-BestIPs

      - name: Fetch IPv4 list from Uouin API
        run: |
          curl -o uouin_ipv4_list.html https://api.uouin.com/cloudflare.html
          # 使用jq解析页面并提取IPv4数据
          ipv4_list=$(grep -oP '(\d+\.\d+\.\d+\.\d+:\d+)' uouin_ipv4_list.html | sort | uniq)

      - name: Compare and update CF-BestIPs if needed
        run: |
          # 获取当前的CF-BestIPs内容
          current_ips=$(cat CF-BestIPs)

          # 比较现有CF-BestIPs和Uouin API的IPv4列表
          if [ "$ipv4_list" != "$current_ips" ]; then
            echo "$ipv4_list" > CF-BestIPs
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add CF-BestIPs
            git commit -m "Update CF-BestIPs with new IP list"
            git push
          else
            echo "No changes needed."
          fi
