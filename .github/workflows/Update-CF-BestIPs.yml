name: Update CF-BestIPs
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update-ips:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        list:
          - name: CF-BestIPs-A
            url: 'https://www.wetest.vip/api/cf2dns/get_cloudflare_ip?key=o1zrmHAF&type=v4'
          - name: CF-BestIPs-B
            url: 'https://cf.090227.xyz/CloudFlareYes'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update IPs for ${{ matrix.list.name }}
        run: |
          set -e

          retry() {
            local n=0
            local max=3
            local delay=5
            until "$@"; do
              n=$((n+1))
              if [ $n -ge $max ]; then
                echo "Command failed after $n attempts: $*"
                return 1
              fi
              echo "Retry $n/$max after $delay seconds..."
              sleep $delay
            done
          }

          IPS=$(retry curl -s -f --connect-timeout 10 --retry 2 --header "Cache-Control: no-cache" "${{ matrix.list.url }}" | \
                grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}|([0-9a-fA-F:]+:+)+[0-9a-fA-F]+' | sort -u) || { echo "Error: failed to fetch or extract IPs"; exit 1; }

          [ -n "$IPS" ] || { echo "Error: IP list is empty"; exit 1; }

          echo "$IPS" | awk '{print $0":8443"}' > "${{ matrix.list.name }}"

          [ -s "${{ matrix.list.name }}" ] || { echo "Error: IP list is empty after processing"; exit 1; }

          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'

          # ä½¿ç”¨ç‹¬ç«‹åˆ†æ”¯
          BRANCH="update-${{ matrix.list.name }}-$(date +%s)"
          git checkout -b "$BRANCH"

          git add "${{ matrix.list.name }}"
          git commit -m "ğŸ¤– Update ${{ matrix.list.name }} $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M')" || true

          # æ¨é€åˆ°ç‹¬ç«‹åˆ†æ”¯
          retry git push origin "$BRANCH" || { echo "Error: git push failed"; exit 1; }
          echo "Successfully pushed ${{ matrix.list.name }} to branch $BRANCH"

          # è‡ªåŠ¨åˆå¹¶åˆ° main åˆ†æ”¯
          retry git checkout main
          retry git pull origin main

          # å°è¯•åˆå¹¶ç‹¬ç«‹åˆ†æ”¯
          if git merge --no-ff "$BRANCH" -m "ğŸ¤– Merge $BRANCH into main"; then
            retry git push origin main
            echo "Successfully merged $BRANCH into main"
          else
            echo "Merge conflict detected. Aborting merge and keeping $BRANCH for manual review."
            git merge --abort
          fi
        shell: /usr/bin/bash -e {0}
