name: Update CF-BestIPs-B
on:
  schedule:
    - cron: '*/20 * * * *'  # 每20分钟执行一次
  workflow_dispatch: # 手动触发

jobs:
  update-ips:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录

      - name: Fetch and update IPv4 addresses
        run: |
          set -e
          # 获取并去除缓存，确保获取最新的网页内容
          curl -s -f --connect-timeout 10 --retry 2 --header "Cache-Control: no-cache" 'https://cf.090227.xyz/CloudFlareYes' | \
          grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | \
          # 去重并保持IP的顺序
          awk '!seen[$0]++' > temp_ips.txt || {
            echo "错误：无法获取或提取 IP 地址"
            exit 1
          }

          # 检查 temp_ips.txt 是否为空
          [ -s temp_ips.txt ] || { echo "错误：IP 列表为空"; exit 1; }

          # 清空 CF-BestIPs-B 文件，并将新的 IP 地址与端口写入文件
          > CF-BestIPs-B
          while IFS= read -r ip; do
            echo "${ip}:8443" >> CF-BestIPs-B
          done < temp_ips.txt

          # 移除临时文件
          rm temp_ips.txt

          # 检查 CF-BestIPs-B 是否为空
          [ -s CF-BestIPs-B ] || { echo "错误：IP 列表为空"; exit 1; }

          # 提交更新到 GitHub 仓库
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          git add CF-BestIPs-B
          git commit -m "自动更新 CF-BestIPs-B $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M')" || true
          git pull --rebase origin main || { echo "错误：git pull --rebase 失败"; exit 1; }
          git push origin main || { echo "错误：git push 失败"; exit 1; }
          echo "成功更新 CF-BestIPs-B"
        shell: /usr/bin/bash -e {0}
