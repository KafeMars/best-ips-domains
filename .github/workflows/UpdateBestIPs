name: Update BestIPs

on:
  schedule:
    - cron: '0 */0 * * *'  # Runs every 6 hours; adjust as needed
  workflow_dispatch:  # Allows manual triggering

jobs:
  update-file:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}  # Use your PAT for checkout with push permissions

      - name: Download latest content from URL
        run: |
          curl -s https://cf.090227.xyz/CloudFlareYes -o new_BestIPs.txt

      - name: Check for changes
        id: check_changes
        run: |
          if ! cmp -s new_BestIPs.txt BestIPs; then
            echo "Changes detected"
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes"
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Update file if changed
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          mv new_BestIPs.txt BestIPs
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add BestIPs
          git commit -m "Automated update: Sync BestIPs from external source"
          git push origin main  # Assuming your default branch is 'main'; change if needed

      - name: Cleanup
        if: always()
        run: rm -f new_BestIPs.txt
